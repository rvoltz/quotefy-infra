services:
  db:
    image: postgres:15.4-alpine
    env_file: [db.env]
    deploy:
      restart_policy:
        condition: on-failure
    secrets:
      - DB_PASSWORD      
    ports:
      - target: 5432
        published: 65432 # Porta publicada para o DB original
        protocol: tcp
        mode: host
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - quotefy-net

  app:
    image: ghcr.io/rvoltz/quotefy:0ba7e6b8c89f09b4d0076f87a58f6dd4e21b7cf1
    env_file: [app.env]
    depends_on:
      - db # Depende do servi√ßo de DB
    deploy:
      restart_policy:
        condition: on-failure
    secrets:
      - DB_PASSWORD
    ports:
      - target: 8080
        published: 62090
        protocol: tcp
        mode: host
    networks:
      - quotefy-net

  whatsapp-api:
    image: ghcr.io/rvoltz/quotefy-whatsapp-api:4481a9aae1575bb174905e0ddcf6888f6e4bb435
    env_file: [whatsapp.env]
    deploy:
      restart_policy:
        condition: on-failure
    depends_on:
      - db
    secrets:
      - DB_PASSWORD
      - WHATSAPP_API_KEY
    ports:
      - target: 3000
        published: 63000
        protocol: tcp
        mode: host
    networks:
      - quotefy-net

networks:
  quotefy-net:
    driver: overlay
    attachable: true

volumes:
  db-data:

secrets:
  DB_PASSWORD:
    external: true
  WHATSAPP_API_KEY:
    external: true